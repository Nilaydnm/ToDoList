@model Entities.ToDoGroup

@{
    ViewData["Title"] = $"{Model.Title} - Yapılacaklar";
}

<style>
    .deadline-expired {
        color: #d00000;
        text-decoration: line-through;
        font-weight: bold;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-3">@Model.Title</h2>

    <a asp-controller="ToDoGroup" asp-action="Index" class="btn btn-secondary mb-4">&larr; Proje Listesine Dön</a>

    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })

    <form asp-controller="ToDo" asp-action="Add" method="post" class="mb-4">
        @Html.AntiForgeryToken()
        <input type="hidden" name="groupId" value="@Model.Id" />

        <div class="d-flex flex-wrap align-items-end gap-3">
            <div class="d-flex flex-column" style="min-width: 250px;">
                <label for="titleInput" class="form-label fw-bold">Başlık</label>
                <input type="text" id="titleInput" name="title" class="form-control"
                       value="@ViewBag.PreviousTitle" placeholder="Görev başlığı..." />
                <span class="text-danger">@Html.ValidationMessage("Title")</span>
            </div>

            <div class="d-flex flex-column" style="min-width: 250px;">
                <label for="deadlineInput" class="form-label fw-bold">Deadline</label>
                <input type="datetime-local" id="deadlineInput" name="deadline" class="form-control"
                       value="@(ViewBag.PreviousDeadline != null ? ((DateTime)ViewBag.PreviousDeadline).ToString("yyyy-MM-ddTHH:mm") : "")" />
                <span class="text-danger">@Html.ValidationMessage("Deadline")</span>
            </div>

            <div class="d-flex flex-column" style="min-width: 100px;">
                <label class="invisible">Ekle</label>
                <button type="submit" class="btn btn-primary w-100">Ekle</button>
            </div>
        </div>
    </form>

    @if (Model.ToDos != null && Model.ToDos.Any())
    {
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>Yapılacaklar</th>
                    <th>Durum</th>
                    <th>Oluşturulma</th>
                    <th>Deadline</th>
                    <th>Tamamlanma</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.ToDos)
                {
                    <tr class="@(item.IsCompleted ? "table-success" : "") @(item.IsDeleted ? "opacity-50" : "")">
                        <td>
                            <form asp-controller="ToDo" asp-action="Edit" method="post" class="d-flex">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="Id" value="@item.Id" />
                                <input type="hidden" name="GroupId" value="@item.GroupId" />
                                <input type="text" name="Title" value="@item.Title" class="form-control me-2 @(item.IsDeleted ? "text-decoration-line-through" : "")" />
                                <input type="datetime-local" name="Deadline" value="@item.Deadline?.ToString("yyyy-MM-ddTHH:mm")" class="form-control me-2" />
                                <button type="submit" class="btn btn-sm btn-warning">Güncelle</button>
                            </form>
                        </td>

                        <td>
                            <form asp-controller="ToDo" asp-action="ToggleComplete" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.Id" />
                                <input type="checkbox" onchange="this.form.submit()" @(item.IsCompleted ? "checked" : "") />
                                <span class="ms-1">
                                    @(item.IsCompleted ? "✔ Tamamlandı" : "⏳ Bekliyor")
                                </span>
                            </form>
                        </td>

                        <td>@item.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                        <td class="@(item.Deadline.HasValue && item.Deadline < DateTime.Now ? "deadline-expired" : "")">
                            @(item.Deadline?.ToString("dd.MM.yyyy HH:mm") ?? "-")
                        </td>
                        <td>@(item.CompletedAt?.ToString("dd.MM.yyyy HH:mm") ?? "-")</td>

                        <td>
                            @if (!item.IsDeleted)
                            {
                               
                                <form asp-controller="ToDo" asp-action="Delete" method="post" class="d-inline"
                                      onsubmit="return confirm('Silmek istediğinize emin misiniz?')">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@item.Id" />
                                    <input type="hidden" name="mode" value="Soft" />
                                    <button type="submit" class="btn btn-sm btn-danger">Sil</button>
                                </form>
                            }
                            else
                            {
                                <div class="d-flex gap-2">
                                    
                                    <form asp-controller="ToDo" asp-action="Delete" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@item.Id" />
                                        <input type="hidden" name="mode" value="UndoSoft" />
                                        <button type="submit" class="btn btn-sm btn-warning">Geri Al</button>
                                    </form>

                                    <form asp-controller="ToDo" asp-action="Delete" method="post" class="d-inline"
                                          onsubmit="return confirm('Kalıcı silinecek. Bu işlem geri alınamaz. Emin misiniz?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@item.Id" />
                                        <input type="hidden" name="mode" value="Hard" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Kalıcı Sil</button>
                                    </form>
                                </div>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">Henüz yapılacaklar eklenmemiş.</div>
    }
</div>
