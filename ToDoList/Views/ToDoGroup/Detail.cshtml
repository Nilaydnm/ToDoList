@model Entities.ToDoGroup

@{
    ViewData["Title"] = $"{Model.Title} - Yapılacaklar";

    var status = (Context.Request.Query["status"].FirstOrDefault() ?? "all").ToLowerInvariant();
    var qText = (Context.Request.Query["q"].FirstOrDefault() ?? "").Trim();

    DateTime? from = null, to = null;
    if (DateTime.TryParse(Context.Request.Query["from"].FirstOrDefault(), out var fromTmp)) from = fromTmp.Date;
    if (DateTime.TryParse(Context.Request.Query["to"].FirstOrDefault(), out var toTmp)) to = toTmp.Date;

    var fromVal = from.HasValue ? from.Value.ToString("yyyy-MM-dd") : "";
    var toVal = to.HasValue ? to.Value.ToString("yyyy-MM-dd") : "";

    bool Contains(string s) => string.IsNullOrWhiteSpace(qText) || (s ?? "").ToLower().Contains(qText.ToLower());

    var tasks = (Model.ToDos ?? new List<Entities.ToDo>()).Where(t => !t.IsDeleted);

    if (status == "active") tasks = tasks.Where(t => !t.IsCompleted);
    else if (status == "done") tasks = tasks.Where(t => t.IsCompleted);

    if (!string.IsNullOrWhiteSpace(qText)) tasks = tasks.Where(t => Contains(t.Title));

    if (from.HasValue) tasks = tasks.Where(t =>
        (t.Deadline.HasValue && t.Deadline.Value.Date >= from.Value) || (t.CreatedAt.Date >= from.Value));
    if (to.HasValue) tasks = tasks.Where(t =>
        (t.Deadline.HasValue && t.Deadline.Value.Date <= to.Value) || (t.CreatedAt.Date <= to.Value));

    tasks = tasks.OrderBy(x => x.IsCompleted).ThenBy(x => x.Deadline ?? DateTime.MaxValue);
}

<style>
    .deadline-expired {
        color: #d00000;
        text-decoration: line-through;
        font-weight: bold;
    }

    /* --- satır içi düzenleme için ufak stil --- */
    .row-editable input[type="text"],
    .row-editable input[type="datetime-local"] {
        pointer-events: none;
        background: #f7fafc;
    }

    .row-editable.editing input[type="text"],
    .row-editable.editing input[type="datetime-local"] {
        pointer-events: auto;
        background: #fff;
        border-color: #b8d2ff;
        box-shadow: 0 0 0 2px rgba(64,121,255,.12);
    }

    .row-actions .btn {
        margin-left: 6px;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-3">@Model.Title</h2>

    <a asp-controller="ToDoGroup" asp-action="Index" class="btn btn-secondary mb-4">
        &larr; Proje Listesine Dön
    </a>

    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })

    <form method="get" asp-action="Detail" class="row g-2 align-items-end mb-4">
        <input type="hidden" name="id" value="@Model.Id" />
        <div class="col-md-3">
            <label class="form-label fw-bold">Durum</label>
            <select name="status" class="form-select" onchange="this.form.submit()">
                @if (status == "all")
                {
                    <option value="all" selected>Tümü</option>
                }
                else
                {
                    <option value="all">Tümü</option>
                }
                @if (status == "active")
                {
                    <option value="active" selected>Aktif</option>
                }
                else
                {
                    <option value="active">Aktif</option>
                }
                @if (status == "done")
                {
                    <option value="done" selected>Tamamlanmış</option>
                }
                else
                {
                    <option value="done">Tamamlanmış</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Arama</label>
            <input type="text" name="q" value="@qText" class="form-control" placeholder="Görev başlığı...">
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">Başlangıç</label>
            <input type="date" name="from" class="form-control" value="@fromVal">
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">Bitiş</label>
            <input type="date" name="to" class="form-control" value="@toVal">
        </div>
        <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-secondary w-100" type="submit">Uygula</button>
            <a asp-action="Detail" asp-route-id="@Model.Id" class="btn btn-outline-secondary w-100">Temizle</a>
        </div>
    </form>

    <form asp-controller="ToDo" asp-action="Add" method="post" class="mb-4">
        @Html.AntiForgeryToken()
        <input type="hidden" name="groupId" value="@Model.Id" />
        <div class="d-flex flex-wrap align-items-end gap-3">
            <div class="d-flex flex-column" style="min-width:260px;">
                <label class="form-label fw-bold">Başlık</label>
                <input type="text" name="title" class="form-control" value="@ViewBag.PreviousTitle" placeholder="Görev başlığı..." />
                <span class="text-danger">@Html.ValidationMessage("Title")</span>
            </div>
            <div class="d-flex flex-column" style="min-width:100px;">
                <label class="invisible">Ekle</label>
                <button type="submit" class="btn btn-primary w-100">Ekle</button>
            </div>
        </div>
    </form>

    @if (tasks.Any())
    {
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>Yapılacaklar</th>
                    <th>Durum</th>
                    <th>Oluşturulma</th>
                    <th>Deadline</th>
                    <th>Tamamlanma</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in tasks)
                {
                    <tr class="@(item.IsCompleted ? "table-success" : "") row-editable">
                        <td>
                            <form asp-controller="ToDo" asp-action="Edit" method="post" class="d-flex w-100 align-items-center gap-2">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="Id" value="@item.Id" />
                                <input type="hidden" name="GroupId" value="@item.GroupId" />

                                <input type="text" name="Title" class="form-control"
                                       value="@item.Title" data-orig="@item.Title" disabled />

                                <input type="datetime-local" name="Deadline" class="form-control"
                                       value="@item.Deadline?.ToString("yyyy-MM-ddTHH:mm")"
                                       data-orig="@item.Deadline?.ToString("yyyy-MM-ddTHH:mm")" disabled />

                                <div class="ms-auto row-actions">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-edit-row>Düzenle</button>
                                    <button type="button" class="btn btn-sm btn-success d-none" data-save-row>Kaydet</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary d-none" data-cancel-row>Vazgeç</button>
                                </div>
                            </form>
                        </td>

                        <td>
                            <form asp-controller="ToDo" asp-action="ToggleComplete" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.Id" />
                                <input type="checkbox" onchange="this.form.submit()" @(item.IsCompleted ? "checked" : "") />
                                <span class="ms-1">@(item.IsCompleted ? "✔ Tamamlandı" : "⏳ Bekliyor")</span>
                            </form>
                        </td>

                        <td>@item.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>

                        <td class="@(item.Deadline.HasValue && item.Deadline < DateTime.Now && !item.IsCompleted ? "deadline-expired" : "")">
                            @(item.Deadline?.ToString("dd.MM.yyyy HH:mm") ?? "-")
                        </td>

                        <td>@(item.CompletedAt?.ToString("dd.MM.yyyy HH:mm") ?? "-")</td>

                        <td>
                            <form asp-controller="ToDo" asp-action="Delete" method="post" class="d-inline"
                                  onsubmit="return confirm('Silmek istediğinize emin misiniz?')">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.Id" />
                                <input type="hidden" name="mode" value="Soft" />
                                <button type="submit" class="btn btn-sm btn-danger">Sil</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">Gösterilecek görev yok.</div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('click', function (e) {
          const t = e.target;
          if (t.matches('[data-edit-row]')) {
            const row = t.closest('.row-editable');
            row.classList.add('editing');
            row.querySelectorAll('input').forEach(x => x.disabled = false);
            row.querySelector('[data-edit-row]').classList.add('d-none');
            row.querySelector('[data-save-row]').classList.remove('d-none');
            row.querySelector('[data-cancel-row]').classList.remove('d-none');
          }
          if (t.matches('[data-cancel-row]')) {
            const row = t.closest('.row-editable');
            row.classList.remove('editing');
            row.querySelectorAll('[data-orig]').forEach(x => {
              x.value = x.getAttribute('data-orig');
            });
            row.querySelectorAll('input').forEach(x => x.disabled = true);
            row.querySelector('[data-edit-row]').classList.remove('d-none');
            row.querySelector('[data-save-row]').classList.add('d-none');
            row.querySelector('[data-cancel-row]').classList.add('d-none');
          }
          if (t.matches('[data-save-row]')) {
            t.closest('form').submit();
          }
        });
    </script>
}
